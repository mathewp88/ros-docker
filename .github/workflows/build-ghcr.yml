name: Build & Push Docker Images to GHCR

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write   # required for GHCR
      id-token: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Find all Dockerfiles
      id: find
      run: |
        files=$(find . -name "Dockerfile*" -type f)
        echo "files<<EOF" >> $GITHUB_OUTPUT
        echo "$files" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Build & Push each image
      run: |
        for file in ${{ steps.find.outputs.files }}; do
          dir=$(dirname "$file")
          name=$(basename "$file" | tr 'A-Z' 'a-z' | tr ' ' '-' )

          if [ "$name" = "dockerfile" ]; then
            name=$(basename "$dir")
          fi

          image="ghcr.io/${{ github.repository_owner }}/$name:latest"

          echo "Building $image from $file"

          docker build -t "$image" -f "$file" "$dir"
          docker push "$image"
        done

